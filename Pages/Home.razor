@page "/"
@using CRMSystem.Services
@inject ICosmosDbService CosmosDbService

<PageTitle>CRM å®¢æˆ¶ç®¡ç†ç³»çµ±</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="jumbotron bg-primary text-white p-5 rounded mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h1 class="display-4">âœ¨ å…¨æ–°é ‚éƒ¨å°èˆªè¨­è¨ˆ</h1>
                <p class="lead">ç¾ä»£åŒ–çš„æ©«å‘å°èˆªæ¬„ï¼Œåƒè€ƒå„ªç§€ç¶²ç«™è¨­è¨ˆï¼Œæä¾›æ›´å¥½çš„ä½¿ç”¨é«”é©—</p>
                <hr class="my-4" style="border-color: rgba(255,255,255,0.3);">
                <div class="row">
                    <div class="col-md-6">
                        <h5>ğŸ¨ è¨­è¨ˆç‰¹è‰²</h5>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-check-circle-fill me-2"></i>ç¾è§€çš„æ¼¸å±¤èƒŒæ™¯</li>
                            <li><i class="bi bi-check-circle-fill me-2"></i>éŸ¿æ‡‰å¼è¨­è¨ˆæ”¯æ´æ‰‹æ©Ÿ</li>
                            <li><i class="bi bi-check-circle-fill me-2"></i>åœ“è§’æŒ‰éˆ•èˆ‡æ‡¸åœæ•ˆæœ</li>
                            <li><i class="bi bi-check-circle-fill me-2"></i>æ´»èºé é¢é«˜äº®é¡¯ç¤º</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>ğŸš€ æŠ€è¡“å„ªå‹¢</h5>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-check-circle-fill me-2"></i>Bootstrap 5 ç¾ä»£çµ„ä»¶</li>
                            <li><i class="bi bi-check-circle-fill me-2"></i>CSS3 å‹•ç•«éæ¸¡</li>
                            <li><i class="bi bi-check-circle-fill me-2"></i>è§¸æ§å‹å–„ç•Œé¢</li>
                            <li><i class="bi bi-check-circle-fill me-2"></i>æ›´å¥½çš„å¯è¨ªå•æ€§</li>
                        </ul>
                    </div>
                </div>
                <a class="btn btn-light btn-lg mt-3" href="/customers" role="button">
                    <i class="bi bi-people-fill"></i> é–‹å§‹é«”é©— CRM ç³»çµ±
                </a>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-people-fill" style="font-size: 3rem; color: #007bff;"></i>
                    <h5 class="card-title mt-3">å®¢æˆ¶ç®¡ç†</h5>
                    <p class="card-text">å®Œæ•´è¨˜éŒ„å®¢æˆ¶åŸºæœ¬è³‡æ–™ã€è¯çµ¡æ–¹å¼åŠèƒŒæ™¯è³‡è¨Š</p>
                    <a href="/customers" class="btn btn-primary">æŸ¥çœ‹å®¢æˆ¶</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-graph-up" style="font-size: 3rem; color: #28a745;"></i>
                    <h5 class="card-title mt-3">æŠ•è³‡è¨˜éŒ„</h5>
                    <p class="card-text">è¿½è¹¤å®¢æˆ¶æŠ•è³‡çµ„åˆã€åŸºé‡‘ç‹€æ³åŠæç›Šåˆ†æ</p>
                    <a href="/investments" class="btn btn-success">ç®¡ç†æŠ•è³‡</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-calendar-check" style="font-size: 3rem; color: #ffc107;"></i>
                    <h5 class="card-title mt-3">æ‹œè¨ªè¨˜éŒ„</h5>
                    <p class="card-text">è¨˜éŒ„å®¢æˆ¶æ‹œè¨ªæ­·ç¨‹åŠå¾ŒçºŒè¿½è¹¤äº‹é …</p>
                    <a href="/visits" class="btn btn-warning">æŸ¥çœ‹è¨˜éŒ„</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-person-plus" style="font-size: 3rem; color: #17a2b8;"></i>
                    <h5 class="card-title mt-3">æ–°å¢å®¢æˆ¶</h5>
                    <p class="card-text">å¿«é€Ÿå»ºç«‹æ–°å®¢æˆ¶æª”æ¡ˆä¸¦é–‹å§‹ç®¡ç†</p>
                    <a href="/customers/create" class="btn btn-info">æ–°å¢å®¢æˆ¶</a>
                </div>
            </div>
        </div>
    </div>

    @if (stats != null)
    {
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>
                            <i class="bi bi-bar-chart"></i> ç³»çµ±çµ±è¨ˆ
                            <button class="btn btn-sm btn-outline-primary ms-2" @onclick="LoadStats">
                                <i class="bi bi-arrow-clockwise"></i> é‡æ–°è¼‰å…¥
                            </button>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h3 class="text-primary">@stats.TotalCustomers</h3>
                                    <p class="text-muted">ç¸½å®¢æˆ¶æ•¸</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h3 class="text-success">@stats.TotalInvestmentRecords</h3>
                                    <p class="text-muted">æŠ•è³‡è¨˜éŒ„æ•¸</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h3 class="text-warning">@stats.TotalVisitRecords</h3>
                                    <p class="text-muted">æ‹œè¨ªè¨˜éŒ„æ•¸</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <h3 class="text-info">@stats.NewCustomersThisMonth</h3>
                                <p class="text-muted">æœ¬æœˆæ–°å®¢æˆ¶</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (isLoading)
    {
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">è¼‰å…¥çµ±è¨ˆè³‡æ–™ä¸­...</span>
                        </div>
                        <p class="mt-2">è¼‰å…¥çµ±è¨ˆè³‡æ–™ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    ç³»çµ±å·²å°±ç·’ï¼é»æ“Šä¸Šæ–¹åŠŸèƒ½å¡ç‰‡é–‹å§‹ä½¿ç”¨
                    <button class="btn btn-sm btn-outline-primary ms-3" @onclick="LoadStats">
                        <i class="bi bi-bar-chart"></i> è¼‰å…¥çµ±è¨ˆè³‡æ–™
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private SystemStats? stats;
    private bool isLoading = false;

    private async Task LoadStats()
    {
        await LoadSystemStats();
        StateHasChanged();
    }

    private async Task LoadSystemStats()
    {
        try
        {
            isLoading = true;
            Console.WriteLine("é–‹å§‹è¼‰å…¥ç³»çµ±çµ±è¨ˆè³‡æ–™...");
            
            var customers = await CosmosDbService.GetCustomersAsync();
            Console.WriteLine($"æˆåŠŸè¼‰å…¥ {customers.Count()} å€‹å®¢æˆ¶");
            
            stats = new SystemStats
            {
                TotalCustomers = customers.Count(),
                TotalInvestmentRecords = customers.SelectMany(c => c.InvestmentRecords).Count(),
                TotalVisitRecords = customers.SelectMany(c => c.VisitRecords).Count(),
                NewCustomersThisMonth = customers.Count(c => c.CreatedDate >= new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1))
            };
            
            Console.WriteLine("ç³»çµ±çµ±è¨ˆè³‡æ–™è¼‰å…¥å®Œæˆ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"è¼‰å…¥ç³»çµ±çµ±è¨ˆè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}");
            Console.WriteLine($"éŒ¯èª¤è©³æƒ…: {ex.StackTrace}");
            // è¨­å®šé è¨­å€¼
            stats = new SystemStats();
        }
        finally
        {
            isLoading = false;
        }
    }

    public class SystemStats
    {
        public int TotalCustomers { get; set; }
        public int TotalInvestmentRecords { get; set; }
        public int TotalVisitRecords { get; set; }
        public int NewCustomersThisMonth { get; set; }
    }
}