@page "/visits/edit/{CustomerId}/{VisitId}"
@using CRMSystem.Models
@using CRMSystem.Services
@inject ICosmosDbService CosmosDbService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>ç·¨è¼¯æ‹œè¨ªè¨˜éŒ„</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-pencil-square"></i> ç·¨è¼¯æ‹œè¨ªè¨˜éŒ„</h2>
            <p class="text-muted">ä¿®æ”¹æ‹œè¨ªè¨˜éŒ„çš„è©³ç´°è³‡è¨Š</p>
        </div>
        <button class="btn btn-outline-secondary" @onclick="GoBack">
            <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
            </div>
            <p class="mt-2">è¼‰å…¥æ‹œè¨ªè¨˜éŒ„ä¸­...</p>
        </div>
    }
    else if (visitRecord == null)
    {
        <div class="alert alert-danger">
            æ‰¾ä¸åˆ°æŒ‡å®šçš„æ‹œè¨ªè¨˜éŒ„
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">æ‹œè¨ªåŸºæœ¬è³‡è¨Š</h5>
                    </div>
                    <div class="card-body">
                        <EditForm Model="@visitRecord" OnValidSubmit="@SaveRecord">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="alert alert-danger" />

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">å®¢æˆ¶</label>
                                    <input type="text" class="form-control" value="@customer?.Name" readonly />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">è² è²¬äºº <span class="text-danger">*</span></label>
                                    <select class="form-select" @bind="visitRecord.Assignee">
                                        <option value="">è«‹é¸æ“‡è² è²¬äºº</option>
                                        <option value="å‘‚æ­¡">å‘‚æ­¡</option>
                                        <option value="å­”éŸ»æ˜‡">å­”éŸ»æ˜‡</option>
                                    </select>
                                    <ValidationMessage For="@(() => visitRecord.Assignee)" />
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">æ‹œè¨ªæ—¥æœŸ <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" @bind="visitRecord.VisitDate" />
                                    <ValidationMessage For="@(() => visitRecord.VisitDate)" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">æ‹œè¨ªæ™‚é–“</label>
                                    <input type="text" class="form-control" @bind="visitRecord.VisitTime" 
                                           placeholder="ä¾‹å¦‚ï¼š14:00" pattern="[0-9]{2}:[0-9]{2}" />
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">æ‹œè¨ªæ–¹å¼</label>
                                    <select class="form-select" @bind="visitRecord.VisitType">
                                        <option value="é¢è«‡">é¢è«‡</option>
                                        <option value="é›»è©±">é›»è©±</option>
                                        <option value="è¦–è¨Š">è¦–è¨Š</option>
                                        <option value="ç°¡è¨Š">ç°¡è¨Š</option>
                                        <option value="EMAIL">EMAIL</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">æ‹œè¨ªåœ°é»</label>
                                    <input type="text" class="form-control" @bind="visitRecord.VisitLocation" 
                                           placeholder="ä¾‹å¦‚ï¼šå®¢æˆ¶å®¶ä¸­ã€è¾¦å…¬å®¤ã€å’–å•¡å»³ç­‰" />
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">æ‹œè¨ªç›®çš„</label>
                                    <input type="text" class="form-control" @bind="visitRecord.VisitPurpose" 
                                           placeholder="ä¾‹å¦‚ï¼šå®šæœŸé—œæ‡·ã€æŠ•è³‡è«®è©¢ã€ç”¢å“ä»‹ç´¹ç­‰" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">å®¢æˆ¶æƒ…ç·’</label>
                                    <select class="form-select" @bind="visitRecord.CustomerMood">
                                        <option value="æ»¿æ„">æ»¿æ„</option>
                                        <option value="ä¸­æ€§">ä¸­æ€§</option>
                                        <option value="ä¸æ»¿">ä¸æ»¿</option>
                                        <option value="æŠ±æ€¨">æŠ±æ€¨</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">è«‡è©±å…§å®¹</label>
                                <textarea class="form-control" @bind="visitRecord.ConversationContent" 
                                          rows="4" placeholder="è¨˜éŒ„èˆ‡å®¢æˆ¶çš„ä¸»è¦è«‡è©±å…§å®¹..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">å®¢æˆ¶é—œæ³¨é»</label>
                                <textarea class="form-control" @bind="visitRecord.CustomerConcerns" 
                                          rows="3" placeholder="å®¢æˆ¶ç‰¹åˆ¥é—œå¿ƒæˆ–åœ¨æ„çš„äº‹é …..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">å®¢æˆ¶å›é¥‹</label>
                                <textarea class="form-control" @bind="visitRecord.CustomerFeedback" 
                                          rows="3" placeholder="å®¢æˆ¶å°æœå‹™æˆ–ç”¢å“çš„å›é¥‹æ„è¦‹..."></textarea>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">æ‹œè¨ªæ•ˆæœè©•åˆ†</label>
                                    <select class="form-select" @bind="visitRecord.VisitRating">
                                        <option value="1">1 - å¾ˆå·®</option>
                                        <option value="2">2 - å·®</option>
                                        <option value="3">3 - æ™®é€š</option>
                                        <option value="4">4 - å¥½</option>
                                        <option value="5">5 - å¾ˆå¥½</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">æ‹œè¨ªæ™‚é•·(åˆ†é˜)</label>
                                    <input type="number" class="form-control" @bind="visitRecord.VisitDuration" 
                                           min="0" max="480" />
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">å¾ŒçºŒè¡Œå‹•è¨ˆåŠƒ</label>
                                <textarea class="form-control" @bind="visitRecord.FollowUpActions" 
                                          rows="3" placeholder="ä¸‹æ¬¡éœ€è¦è·Ÿé€²çš„å…·é«”è¡Œå‹•..."></textarea>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">é è¨ˆè¿½è¹¤æ—¥æœŸ</label>
                                    <input type="date" class="form-control" @bind="visitRecord.FollowUpDate" />
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" @bind="visitRecord.FollowUpCompleted" />
                                        <label class="form-check-label">
                                            è¿½è¹¤å·²å®Œæˆ
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="visitRecord.IsHotLead" />
                                    <label class="form-check-label">
                                        æ¨™è¨˜ç‚ºç†±é–€å®¢æˆ¶ ğŸ”¥
                                    </label>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" @onclick="GoBack">
                                    <i class="bi bi-x"></i> å–æ¶ˆ
                                </button>
                                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    }
                                    <i class="bi bi-check"></i> æ›´æ–°è¨˜éŒ„
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">è¨˜éŒ„è³‡è¨Š</h6>
                    </div>
                    <div class="card-body">
                        @if (customer != null)
                        {
                            <div class="alert alert-info">
                                <h6><i class="bi bi-person-check"></i> å®¢æˆ¶è³‡è¨Š</h6>
                                <p class="mb-1"><strong>å§“åï¼š</strong>@customer.Name</p>
                                <p class="mb-1"><strong>é›»è©±ï¼š</strong>@customer.Phone</p>
                                <p class="mb-0"><strong>è² è²¬äººï¼š</strong>@customer.AssignedTo</p>
                            </div>
                        }
                        
                        <div class="alert alert-secondary">
                            <h6><i class="bi bi-clock-history"></i> è¨˜éŒ„æ­·å²</h6>
                            <p class="mb-1"><strong>å»ºç«‹æ™‚é–“ï¼š</strong>@visitRecord.CreatedDate.ToString("yyyy/MM/dd HH:mm")</p>
                            <p class="mb-0"><strong>æœ€å¾Œä¿®æ”¹ï¼š</strong>@visitRecord.LastModified.ToString("yyyy/MM/dd HH:mm")</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string CustomerId { get; set; } = string.Empty;
    [Parameter] public string VisitId { get; set; } = string.Empty;

    private VisitRecord? visitRecord;
    private Customer? customer;
    private bool isLoading = true;
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            
            // è¼‰å…¥å®¢æˆ¶è³‡æ–™
            customer = await CosmosDbService.GetCustomerAsync(CustomerId);
            if (customer == null)
            {
                await JSRuntime.InvokeVoidAsync("alert", "æ‰¾ä¸åˆ°æŒ‡å®šçš„å®¢æˆ¶");
                Navigation.NavigateTo("/visits");
                return;
            }

            // æ‰¾åˆ°æŒ‡å®šçš„æ‹œè¨ªè¨˜éŒ„
            visitRecord = customer.VisitRecords.FirstOrDefault(v => v.Id == VisitId);
            if (visitRecord == null)
            {
                await JSRuntime.InvokeVoidAsync("alert", "æ‰¾ä¸åˆ°æŒ‡å®šçš„æ‹œè¨ªè¨˜éŒ„");
                Navigation.NavigateTo("/visits");
                return;
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"è¼‰å…¥è³‡æ–™å¤±æ•—: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveRecord()
    {
        if (visitRecord == null || customer == null) return;

        try
        {
            isSaving = true;

            // æ›´æ–°ä¿®æ”¹æ™‚é–“
            visitRecord.LastModified = DateTime.UtcNow;

            // æ›´æ–°å®¢æˆ¶è³‡æ–™
            await CosmosDbService.UpdateCustomerAsync(customer);

            await JSRuntime.InvokeVoidAsync("alert", "æ‹œè¨ªè¨˜éŒ„å·²æˆåŠŸæ›´æ–°ï¼");
            
            // è¿”å›æ‹œè¨ªè¨˜éŒ„åˆ—è¡¨
            Navigation.NavigateTo("/visits");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"æ›´æ–°å¤±æ•—: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/visits");
    }
}