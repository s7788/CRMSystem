@page "/visits"
@using CRMSystem.Models
@using CRMSystem.Services
@inject ICosmosDbService CosmosDbService
@inject IJSRuntime JSRuntime

<PageTitle>æ‹œè¨ªè¨˜éŒ„ç®¡ç†</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-calendar-check"></i> æ‹œè¨ªè¨˜éŒ„ç®¡ç†</h2>
            <p class="text-muted">ç®¡ç†æ‰€æœ‰å®¢æˆ¶çš„æ‹œè¨ªè¨˜éŒ„å’Œè¿½è¹¤äº‹é …</p>
        </div>
        <button class="btn btn-primary" @onclick="ShowAddModal">
            <i class="bi bi-plus"></i> æ–°å¢æ‹œè¨ªè¨˜éŒ„
        </button>
    </div>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">@totalVisits</h3>
                    <p class="text-muted mb-0">ç¸½æ‹œè¨ªæ¬¡æ•¸</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">@pendingFollowUps</h3>
                    <p class="text-muted mb-0">å¾…è¿½è¹¤äº‹é …</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">@thisMonthVisits</h3>
                    <p class="text-muted mb-0">æœ¬æœˆæ‹œè¨ª</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">@averageRating.ToString("F1")</h3>
                    <p class="text-muted mb-0">å¹³å‡è©•åˆ†</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¯©é¸å™¨ -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">è² è²¬äºº</label>
                    <select class="form-select" @bind="selectedAssignee" @bind:after="FilterRecords">
                        <option value="">å…¨éƒ¨</option>
                        <option value="å‘‚æ­¡">å‘‚æ­¡</option>
                        <option value="å­”éŸ»æ˜‡">å­”éŸ»æ˜‡</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">æ‹œè¨ªæ–¹å¼</label>
                    <select class="form-select" @bind="selectedMethod" @bind:after="FilterRecords">
                        <option value="">å…¨éƒ¨</option>
                        <option value="é¢è«‡">é¢è«‡</option>
                        <option value="é›»è©±">é›»è©±</option>
                        <option value="è¦–è¨Š">è¦–è¨Š</option>
                        <option value="ç°¡è¨Š">ç°¡è¨Š</option>
                        <option value="EMAIL">EMAIL</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">è¿½è¹¤ç‹€æ…‹</label>
                    <select class="form-select" @bind="selectedStatus" @bind:after="FilterRecords">
                        <option value="">å…¨éƒ¨</option>
                        <option value="å¾…è™•ç†">å¾…è™•ç†</option>
                        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                        <option value="é€¾æœŸ">é€¾æœŸ</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">æœå°‹</label>
                    <input type="text" class="form-control" placeholder="æœå°‹å®¢æˆ¶æˆ–å…§å®¹" @bind="searchKeyword" @oninput="FilterRecords" />
                </div>
            </div>
        </div>
    </div>

    <!-- æ‹œè¨ªè¨˜éŒ„åˆ—è¡¨ -->
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
            </div>
            <p class="mt-2">è¼‰å…¥æ‹œè¨ªè¨˜éŒ„ä¸­...</p>
        </div>
    }
    else if (filteredRecords?.Any() == true)
    {
        <div class="row">
            @foreach (var item in filteredRecords.Take(20))
            {
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-start">
                                        <div class="me-3">
                                            <i class="@item.Record.VisitTypeIcon" style="font-size: 1.5rem; color: #007bff;"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h5 class="mb-1">
                                                @item.Customer.Name
                                                @if (item.Record.IsHotLead)
                                                {
                                                    <span class="badge bg-danger ms-1">ğŸ”¥ ç†±é–€</span>
                                                }
                                            </h5>
                                            <p class="text-muted mb-2">
                                                <i class="bi bi-calendar3"></i> @item.Record.VisitDate.ToString("yyyy/MM/dd") @item.Record.VisitTime
                                                <span class="mx-2">|</span>
                                                <i class="bi bi-person"></i> @item.Record.Assignee
                                                <span class="mx-2">|</span>
                                                <span class="badge @item.Record.MoodColor">@item.Record.CustomerMood</span>
                                            </p>
                                            @if (!string.IsNullOrEmpty(item.Record.VisitPurpose))
                                            {
                                                <p class="mb-2"><strong>ç›®çš„ï¼š</strong>@item.Record.VisitPurpose</p>
                                            }
                                            @if (!string.IsNullOrEmpty(item.Record.ConversationContent))
                                            {
                                                <p class="mb-2 text-truncate" style="max-width: 500px;">
                                                    <strong>å…§å®¹ï¼š</strong>@item.Record.ConversationContent
                                                </p>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-end">
                                        <div class="mb-2">
                                            <span class="badge @GetStatusBadgeClass(item.Record.FollowUpStatus)">
                                                @item.Record.FollowUpStatus
                                            </span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(item.Record.CustomerFeedback))
                                        {
                                            <div class="mb-2">
                                                <span class="text-success">â­â­â­â­â­</span>
                                            </div>
                                        }
                                        @if (item.Record.IsHotLead)
                                        {
                                            <div class="mb-2">
                                                <small class="text-muted">é‡è¦å®¢æˆ¶ï¼š</small>
                                                <span class="badge bg-danger">ğŸ”¥ ç†±é–€</span>
                                            </div>
                                        }
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" @onclick="() => ViewDetails(item)">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-success" @onclick="() => EditRecord(item.Record)">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (filteredRecords.Count() > 20)
        {
            <div class="text-center mt-4">
                <div class="alert alert-info">
                    é¡¯ç¤ºå‰ 20 ç­†è¨˜éŒ„ï¼Œå…± @filteredRecords.Count() ç­†ã€‚è«‹ä½¿ç”¨ç¯©é¸å™¨ç¸®å°ç¯„åœã€‚
                </div>
            </div>
        }
    }
    else
    {
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
            <h4 class="mt-3 text-muted">æ²’æœ‰æ‰¾åˆ°æ‹œè¨ªè¨˜éŒ„</h4>
            <p class="text-muted">å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æ–°å¢ç¬¬ä¸€ç­†æ‹œè¨ªè¨˜éŒ„</p>
        </div>
    }
</div>

@code {
    private List<Customer> customers = new();
    private List<VisitRecordWithCustomer> allRecords = new();
    private IEnumerable<VisitRecordWithCustomer> filteredRecords = new List<VisitRecordWithCustomer>();
    
    private string selectedAssignee = "";
    private string selectedMethod = "";
    private string selectedStatus = "";
    private string searchKeyword = "";
    
    private int totalVisits = 0;
    private int pendingFollowUps = 0;
    private int thisMonthVisits = 0;
    private double averageRating = 0.0;
    
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            customers = (await CosmosDbService.GetCustomersAsync()).ToList();

            // çµ„åˆæ‹œè¨ªè¨˜éŒ„èˆ‡å®¢æˆ¶è³‡æ–™
            allRecords = customers
                .SelectMany(c => c.VisitRecords.Select(v => new VisitRecordWithCustomer 
                { 
                    Customer = c, 
                    Record = v 
                }))
                .OrderByDescending(x => x.Record.VisitDate)
                .ToList();

            // è¨ˆç®—çµ±è¨ˆè³‡æ–™
            totalVisits = allRecords.Count;
            pendingFollowUps = allRecords.Count(x => x.Record.FollowUpStatus == "å¾…è™•ç†" || x.Record.FollowUpStatus == "é€¾æœŸ");
            thisMonthVisits = allRecords.Count(x => x.Record.VisitDate >= new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1));
            averageRating = allRecords.Any() ? 4.2 : 0.0; // æš«æ™‚ä½¿ç”¨å›ºå®šå€¼

            filteredRecords = allRecords;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"è¼‰å…¥æ‹œè¨ªè¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterRecords()
    {
        filteredRecords = allRecords.Where(record =>
            (string.IsNullOrEmpty(selectedAssignee) || record.Record.Assignee == selectedAssignee) &&
            (string.IsNullOrEmpty(selectedMethod) || record.Record.VisitType == selectedMethod) &&
            (string.IsNullOrEmpty(selectedStatus) || record.Record.FollowUpStatus == selectedStatus) &&
            (string.IsNullOrEmpty(searchKeyword) || 
             record.Customer.Name.Contains(searchKeyword, StringComparison.OrdinalIgnoreCase) ||
             (!string.IsNullOrEmpty(record.Record.ConversationContent) && record.Record.ConversationContent.Contains(searchKeyword, StringComparison.OrdinalIgnoreCase)) ||
             (!string.IsNullOrEmpty(record.Record.VisitPurpose) && record.Record.VisitPurpose.Contains(searchKeyword, StringComparison.OrdinalIgnoreCase)))
        ).ToList();

        StateHasChanged();
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "å·²å®Œæˆ" => "bg-success",
            "é€¾æœŸ" => "bg-danger",
            "å¾…è™•ç†" => "bg-warning",
            _ => "bg-secondary"
        };
    }

    private async Task ViewDetails(VisitRecordWithCustomer item)
    {
        // è·³è½‰åˆ°å®¢æˆ¶è©³ç´°é é¢
        await JSRuntime.InvokeVoidAsync("open", $"/customers/{item.Customer.Id}", "_blank");
    }

    private void EditRecord(VisitRecord record)
    {
        // é€™è£¡å¯ä»¥å¯¦ç¾ç·¨è¼¯åŠŸèƒ½
        Console.WriteLine($"ç·¨è¼¯æ‹œè¨ªè¨˜éŒ„: {record.Id}");
    }

    private void ShowAddModal()
    {
        // é€™è£¡å¯ä»¥å¯¦ç¾æ–°å¢åŠŸèƒ½
        Console.WriteLine("é¡¯ç¤ºæ–°å¢æ‹œè¨ªè¨˜éŒ„æ¨¡æ…‹æ¡†");
    }

    public class VisitRecordWithCustomer
    {
        public Customer Customer { get; set; } = new();
        public VisitRecord Record { get; set; } = new();
    }
}