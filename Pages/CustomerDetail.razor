@page "/customers/{CustomerId}"
@using CRMSystem.Models
@using CRMSystem.Services
@inject ICosmosDbService CosmosDbService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>ÂÆ¢Êà∂Ë©≥Á¥∞Ë≥áÊñô</PageTitle>

@if (customer == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">ËºâÂÖ•‰∏≠...</span>
        </div>
    </div>
}
else
{
    <div class="container-fluid">
        <!-- ÂÆ¢Êà∂Âü∫Êú¨Ë≥áÊñô -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>@customer.Name - ÂÆ¢Êà∂Ë©≥Á¥∞Ë≥áÊñô</h4>
                        <div>
                            <button class="btn btn-warning btn-sm me-2" @onclick="EditCustomer">
                                <i class="bi bi-pencil"></i> Á∑®ËºØ
                            </button>
                            <button class="btn btn-secondary btn-sm" @onclick="BackToList">
                                <i class="bi bi-arrow-left"></i> ËøîÂõûÂàóË°®
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr><td><strong>ÂßìÂêçÔºö</strong></td><td>@customer.Name</td></tr>
                                    <tr><td><strong>ÊÄßÂà•Ôºö</strong></td><td>@customer.Gender</td></tr>
                                    <tr><td><strong>Âá∫ÁîüÊó•ÊúüÔºö</strong></td><td>@(customer.BirthDate?.ToString("yyyy/MM/dd") ?? "Êú™Ë®≠ÂÆö")</td></tr>
                                    <tr><td><strong>ËÅ∑Ê•≠Ôºö</strong></td><td>@customer.Occupation</td></tr>
                                    <tr><td><strong>ÈõªË©±Ôºö</strong></td><td>@customer.Phone</td></tr>
                                    <tr><td><strong>ÊâãÊ©üÔºö</strong></td><td>@customer.Mobile</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr><td><strong>Âú∞ÂùÄÔºö</strong></td><td>@customer.Address</td></tr>
                                    <tr><td><strong>Â≠êÂ•≥Ë≥áË®äÔºö</strong></td><td>@customer.ChildrenInfo</td></tr>
                                    <tr><td><strong>ÂÆ¢Êà∂‰æÜÊ∫êÔºö</strong></td><td>@customer.CustomerSource</td></tr>
                                    <tr><td><strong>ÂÆ¢Êà∂Ê≠∏Â±¨Ôºö</strong></td><td>@customer.AssignedTo</td></tr>
                                    <tr><td><strong>Âª∫Á´ãÊó•ÊúüÔºö</strong></td><td>@customer.CreatedDate.ToString("yyyy/MM/dd HH:mm")</td></tr>
                                    <tr><td><strong>ÊúÄÂæå‰øÆÊîπÔºö</strong></td><td>@customer.LastModified.ToString("yyyy/MM/dd HH:mm")</td></tr>
                                </table>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(customer.Notes))
                        {
                            <div class="row mt-3">
                                <div class="col">
                                    <strong>ÂÇôË®ªÔºö</strong>
                                    <div class="border rounded p-2 mt-1" style="background-color: #f8f9fa;">
                                        @customer.Notes
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊäïË≥áË®òÈåÑ -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-graph-up"></i> ÊäïË≥áË®òÈåÑ</h5>
                        <div>
                            <button class="btn btn-success btn-sm me-2" @onclick="AddInvestmentRecord">
                                <i class="bi bi-plus"></i> Êñ∞Â¢ûÊäïË≥áË®òÈåÑ
                            </button>
                            <a href="/customers/@CustomerId/investments" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-list-ul"></i> Ë©≥Á¥∞ÁÆ°ÁêÜ
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (customer.InvestmentRecords?.Any() == true)
                        {
                            <!-- ÊäïË≥áÊëòË¶Å -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">Á∏ΩÊäïË≥áÈáëÈ°ç</h6>
                                        <h5 class="text-primary">@customer.InvestmentRecords.Sum(r => r.Amount).ToString("C0")</h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">Á∏ΩÊêçÁõä</h6>
                                        <h5 class="@(customer.InvestmentRecords.Sum(r => r.ProfitLoss) >= 0 ? "text-success" : "text-danger")">
                                            @customer.InvestmentRecords.Sum(r => r.ProfitLoss).ToString("C0")
                                        </h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">ÊåÅÊúâÈ†ÖÁõÆ</h6>
                                        <h5 class="text-info">@customer.InvestmentRecords.Count(r => r.Status == "ÊåÅÊúâ‰∏≠")</h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">Á∏ΩÈÖçÊÅØ</h6>
                                        <h5 class="text-warning">@customer.InvestmentRecords.Sum(r => r.Dividend).ToString("C0")</h5>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Êó•Êúü</th>
                                            <th>È°ûÂûã</th>
                                            <th>Âü∫Èáë/ÂïÜÂìÅÂêçÁ®±</th>
                                            <th>Âπ£Âà•</th>
                                            <th class="text-end">ÈáëÈ°ç</th>
                                            <th class="text-end">ÊêçÁõä</th>
                                            <th class="text-end">Â†±ÈÖ¨Áéá</th>
                                            <th>ÁãÄÊÖã</th>
                                            <th>Êìç‰Ωú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var record in customer.InvestmentRecords.OrderByDescending(r => r.OrderDate).Take(5))
                                        {
                                            <tr>
                                                <td>@record.OrderDate.ToString("MM/dd")</td>
                                                <td>
                                                    <span class="badge bg-secondary">@record.AssetType</span>
                                                </td>
                                                <td>
                                                    <div>
                                                        <strong>@record.FundName</strong>
                                                        @if (!string.IsNullOrEmpty(record.FundCode))
                                                        {
                                                            <br><small class="text-muted">@record.FundCode</small>
                                                        }
                                                    </div>
                                                </td>
                                                <td>@record.Currency</td>
                                                <td class="text-end">@record.Amount.ToString("N0")</td>
                                                <td class="text-end @record.ProfitLossColor">
                                                    <strong>@record.ProfitLoss.ToString("N0")</strong>
                                                </td>
                                                <td class="text-end @record.ProfitLossColor">
                                                    <strong>@record.ProfitLossPercentage.ToString("F2")%</strong>
                                                </td>
                                                <td>
                                                    <span class="badge bg-@record.StatusColor">@record.Status</span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary btn-sm" @onclick="() => EditInvestmentRecord(record)">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteInvestmentRecord(record.Id)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            @if (customer.InvestmentRecords.Count > 5)
                            {
                                <div class="text-center mt-3">
                                    <a href="/customers/@CustomerId/investments" class="btn btn-outline-primary">
                                        Êü•ÁúãÂÖ®ÈÉ® @customer.InvestmentRecords.Count Á≠ÜË®òÈåÑ <i class="bi bi-arrow-right"></i>
                                    </a>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Â∞öÁÑ°ÊäïË≥áË®òÈåÑ
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊãúË®™Ë®òÈåÑ -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-calendar-check"></i> ÊãúË®™Ë®òÈåÑ</h5>
                        <div>
                            <button class="btn btn-primary btn-sm me-2" @onclick="AddVisitRecord">
                                <i class="bi bi-plus"></i> Êñ∞Â¢ûÊãúË®™Ë®òÈåÑ
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (customer.VisitRecords?.Any() == true)
                        {
                            <!-- ÊãúË®™Áµ±Ë®à -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">Á∏ΩÊãúË®™Ê¨°Êï∏</h6>
                                        <h5 class="text-primary">@customer.VisitRecords.Count</h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">Âπ≥ÂùáË©ïÂàÜ</h6>
                                        <h5 class="text-success">
                                            @customer.VisitRecords.Average(r => r.VisitRating).ToString("F1")
                                            <small>(@(new string('‚òÖ', (int)Math.Round(customer.VisitRecords.Average(r => r.VisitRating)))))</small>
                                        </h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">ÂæÖËøΩËπ§</h6>
                                        <h5 class="text-warning">@customer.VisitRecords.Count(r => r.FollowUpDate.HasValue && !r.FollowUpCompleted)</h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">ÊúÄËøëÊãúË®™</h6>
                                        <h5 class="text-info">@customer.VisitRecords.Max(r => r.VisitDate).ToString("MM/dd")</h5>
                                    </div>
                                </div>
                            </div>

                            @foreach (var record in customer.VisitRecords.OrderByDescending(r => r.VisitDate).Take(3))
                            {
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <h6>
                                                    <i class="@record.VisitTypeIcon"></i>
                                                    @record.VisitDate.ToString("yyyy/MM/dd") @record.VisitTime - @record.Assignee
                                                    @if (record.IsHotLead)
                                                    {
                                                        <span class="badge bg-danger ms-1">üî•</span>
                                                    }
                                                </h6>
                                                <small class="text-muted">
                                                    <span class="badge bg-info me-1">@record.VisitType</span>
                                                    <span class="badge bg-@record.MoodColor me-1">@record.CustomerMood</span>
                                                    <span class="text-warning">@record.RatingStars</span>
                                                </small>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" @onclick="() => EditVisitRecord(record)">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" @onclick="() => DeleteVisitRecord(record.Id)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        @if (!string.IsNullOrEmpty(record.VisitPurpose))
                                        {
                                            <div class="mt-2">
                                                <small><strong>ÊãúË®™ÁõÆÁöÑÔºö</strong> @record.VisitPurpose</small>
                                            </div>
                                        }

                                        @if (!string.IsNullOrEmpty(record.ConversationContent))
                                        {
                                            <div class="mt-2">
                                                <strong>Â∞çË©±ÂÖßÂÆπÔºö</strong>
                                                <div class="mt-1">@(record.ConversationContent.Length > 150 ? record.ConversationContent.Substring(0, 150) + "..." : record.ConversationContent)</div>
                                            </div>
                                        }
                                        
                                        @if (!string.IsNullOrEmpty(record.InvestmentAdjustments))
                                        {
                                            <div class="mt-2">
                                                <strong>ÊäïË≥áË™øÊï¥Ôºö</strong>
                                                <div class="mt-1">@record.InvestmentAdjustments</div>
                                            </div>
                                        }
                                        
                                        @if (!string.IsNullOrEmpty(record.FollowUpActions))
                                        {
                                            <div class="mt-2">
                                                <strong>ÂæåÁ∫åËøΩËπ§Ôºö</strong>
                                                <div class="mt-1">
                                                    @record.FollowUpActions
                                                    @if (record.FollowUpDate.HasValue)
                                                    {
                                                        <span class="badge bg-@record.FollowUpStatusColor ms-2">
                                                            @record.FollowUpDate.Value.ToString("MM/dd") - @record.FollowUpStatus
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                        }

                                        @if (record.Tags?.Any() == true)
                                        {
                                            <div class="mt-2">
                                                @foreach (var tag in record.Tags)
                                                {
                                                    <span class="badge bg-light text-dark me-1">#@tag</span>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Â∞öÁÑ°ÊãúË®™Ë®òÈåÑ
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Êñ∞Â¢ûÊäïË≥áË®òÈåÑÊ®°ÊÖãÊ°Ü -->
@if (showInvestmentModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Êñ∞Â¢ûÊäïË≥áË®òÈåÑ</h5>
                    <button type="button" class="btn-close" @onclick="CloseInvestmentModal"></button>
                </div>
                <EditForm Model="newInvestmentRecord" OnValidSubmit="SaveInvestmentRecord">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">‰∏ãÂñÆÊó•Êúü <span class="text-danger">*</span></label>
                                <InputDate class="form-control" @bind-Value="newInvestmentRecord.OrderDate" />
                                <ValidationMessage For="@(() => newInvestmentRecord.OrderDate)" class="text-danger" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ë≥áÁî¢È°ûÂûã</label>
                                <InputSelect class="form-select" @bind-Value="newInvestmentRecord.AssetType">
                                    <option value="Âü∫Èáë">Âü∫Èáë</option>
                                    <option value="ÂÇµÂà∏">ÂÇµÂà∏</option>
                                    <option value="ËÇ°Á•®">ËÇ°Á•®</option>
                                    <option value="Â≠òÊ¨æ">Â≠òÊ¨æ</option>
                                    <option value="‰øùÈö™">‰øùÈö™</option>
                                </InputSelect>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Âü∫Èáë/ÂïÜÂìÅÂêçÁ®±</label>
                                <InputText class="form-control" @bind-Value="newInvestmentRecord.FundName" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Âü∫Èáë‰ª£Á¢º</label>
                                <InputText class="form-control" @bind-Value="newInvestmentRecord.FundCode" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Âπ£Âà• <span class="text-danger">*</span></label>
                                <InputSelect class="form-select" @bind-Value="newInvestmentRecord.Currency">
                                    <option value="">Ë´ãÈÅ∏Êìá</option>
                                    <option value="TWD">Âè∞Âπ£ (TWD)</option>
                                    <option value="USD">ÁæéÈáë (USD)</option>
                                    <option value="EUR">Ê≠êÂÖÉ (EUR)</option>
                                    <option value="JPY">Êó•Âúì (JPY)</option>
                                    <option value="CNY">‰∫∫Ê∞ëÂπ£ (CNY)</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => newInvestmentRecord.Currency)" class="text-danger" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ÊäïË≥áÈáëÈ°ç <span class="text-danger">*</span></label>
                                <InputNumber class="form-control" @bind-Value="newInvestmentRecord.Amount" />
                                <ValidationMessage For="@(() => newInvestmentRecord.Amount)" class="text-danger" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">È¢®Èö™Á≠âÁ¥ö</label>
                                <InputSelect class="form-select" @bind-Value="newInvestmentRecord.RiskLevel">
                                    <option value="‰ΩéÈ¢®Èö™">‰ΩéÈ¢®Èö™</option>
                                    <option value="‰∏≠Á≠â">‰∏≠Á≠âÈ¢®Èö™</option>
                                    <option value="È´òÈ¢®Èö™">È´òÈ¢®Èö™</option>
                                </InputSelect>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ÊåÅÊúâÂñÆ‰ΩçÊï∏</label>
                                <InputNumber class="form-control" @bind-Value="newInvestmentRecord.Units" />
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ÂñÆ‰ΩçÊ∑®ÂÄº</label>
                                <InputNumber class="form-control" @bind-Value="newInvestmentRecord.UnitPrice" />
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ÁõÆÂâçÂ∏ÇÂÄº</label>
                                <InputNumber class="form-control" @bind-Value="newInvestmentRecord.CurrentValue" />
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ÈÖçÊÅØÈáëÈ°ç</label>
                                <InputNumber class="form-control" @bind-Value="newInvestmentRecord.Dividend" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ÊêçÁõäÈáëÈ°ç</label>
                                <InputNumber class="form-control" @bind-Value="newInvestmentRecord.ProfitLoss" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ÊêçÁõäÁôæÂàÜÊØî (%)</label>
                                <InputNumber class="form-control" @bind-Value="newInvestmentRecord.ProfitLossPercentage" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ÁãÄÊÖã</label>
                                <InputSelect class="form-select" @bind-Value="newInvestmentRecord.Status">
                                    <option value="ÊåÅÊúâ‰∏≠">ÊåÅÊúâ‰∏≠</option>
                                    <option value="Â∑≤Ë¥ñÂõû">Â∑≤Ë¥ñÂõû</option>
                                    <option value="Â∑≤ÂÅúÊêç">Â∑≤ÂÅúÊêç</option>
                                    <option value="Â∑≤Áç≤Âà©‰∫ÜÁµê">Â∑≤Áç≤Âà©‰∫ÜÁµê</option>
                                </InputSelect>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ÂÇôË®ª</label>
                            <InputTextArea class="form-control" rows="2" @bind-Value="newInvestmentRecord.Notes" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseInvestmentModal">ÂèñÊ∂à</button>
                        <button type="submit" class="btn btn-success">ÂÑ≤Â≠ò</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- Êñ∞Â¢ûÊãúË®™Ë®òÈåÑÊ®°ÊÖãÊ°Ü -->
@if (showVisitModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Êñ∞Â¢ûÊãúË®™Ë®òÈåÑ</h5>
                    <button type="button" class="btn-close" @onclick="CloseVisitModal"></button>
                </div>
                <EditForm Model="newVisitRecord" OnValidSubmit="SaveVisitRecord">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ÊãúË®™Êó•Êúü <span class="text-danger">*</span></label>
                                <InputDate class="form-control" @bind-Value="newVisitRecord.VisitDate" />
                                <ValidationMessage For="@(() => newVisitRecord.VisitDate)" class="text-danger" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ë≤†Ë≤¨‰∫∫ <span class="text-danger">*</span></label>
                                <InputSelect class="form-select" @bind-Value="newVisitRecord.Assignee">
                                    <option value="">Ë´ãÈÅ∏Êìá</option>
                                    <option value="ÂëÇÊ≠°">ÂëÇÊ≠°</option>
                                    <option value="Â≠îÈüªÊòá">Â≠îÈüªÊòá</option>
                                    <option value="Â¶πÂ¶π">Â¶πÂ¶π</option>
                                    <option value="ÂÖ∂‰ªñÂêå‰∫ã">ÂÖ∂‰ªñÂêå‰∫ã</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => newVisitRecord.Assignee)" class="text-danger" />
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Â∞çË©±ÂÖßÂÆπ</label>
                            <InputTextArea class="form-control" rows="4" @bind-Value="newVisitRecord.ConversationContent" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ÊäïË≥áË™øÊï¥</label>
                            <InputTextArea class="form-control" rows="3" @bind-Value="newVisitRecord.InvestmentAdjustments" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ÂæåÁ∫åËøΩËπ§‰∫ãÈ†Ö</label>
                            <InputTextArea class="form-control" rows="3" @bind-Value="newVisitRecord.FollowUpActions" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseVisitModal">ÂèñÊ∂à</button>
                        <button type="submit" class="btn btn-primary">ÂÑ≤Â≠ò</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string CustomerId { get; set; } = string.Empty;
    
    private Customer? customer;
    private bool showInvestmentModal = false;
    private bool showVisitModal = false;
    private InvestmentRecord newInvestmentRecord = new();
    private VisitRecord newVisitRecord = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomer();
    }

    private async Task LoadCustomer()
    {
        try
        {
            customer = await CosmosDbService.GetCustomerAsync(CustomerId);
            if (customer == null)
            {
                Navigation.NavigateTo("/customers");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ËºâÂÖ•ÂÆ¢Êà∂Ë≥áÊñôÊôÇÁôºÁîüÈåØË™§: {ex.Message}");
            Navigation.NavigateTo("/customers");
        }
    }

    private void EditCustomer()
    {
        Navigation.NavigateTo($"/customers/{CustomerId}/edit");
    }

    private void BackToList()
    {
        Navigation.NavigateTo("/customers");
    }

    private void AddInvestmentRecord()
    {
        newInvestmentRecord = new InvestmentRecord();
        showInvestmentModal = true;
    }

    private void EditInvestmentRecord(InvestmentRecord record)
    {
        newInvestmentRecord = new InvestmentRecord
        {
            Id = record.Id,
            OrderDate = record.OrderDate,
            Currency = record.Currency,
            FundName = record.FundName,
            FundCode = record.FundCode,
            Amount = record.Amount,
            Units = record.Units,
            UnitPrice = record.UnitPrice,
            CurrentValue = record.CurrentValue,
            ProfitLoss = record.ProfitLoss,
            ProfitLossPercentage = record.ProfitLossPercentage,
            AssetType = record.AssetType,
            RiskLevel = record.RiskLevel,
            Status = record.Status,
            PurchaseType = record.PurchaseType,
            MonthlyAmount = record.MonthlyAmount,
            SellDate = record.SellDate,
            SellAmount = record.SellAmount,
            Commission = record.Commission,
            Dividend = record.Dividend,
            Notes = record.Notes
        };
        showInvestmentModal = true;
    }

    private void CloseInvestmentModal()
    {
        showInvestmentModal = false;
        newInvestmentRecord = new InvestmentRecord();
    }

    private async Task SaveInvestmentRecord()
    {
        if (customer != null)
        {
            customer.InvestmentRecords.Add(newInvestmentRecord);
            await CosmosDbService.UpdateCustomerAsync(customer);
            CloseInvestmentModal();
            await LoadCustomer();
        }
    }

    private async Task DeleteInvestmentRecord(string recordId)
    {
        if (customer != null && await JSRuntime.InvokeAsync<bool>("confirm", "Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÊäïË≥áË®òÈåÑÂóéÔºü"))
        {
            customer.InvestmentRecords.RemoveAll(r => r.Id == recordId);
            await CosmosDbService.UpdateCustomerAsync(customer);
            await LoadCustomer();
        }
    }

    private void AddVisitRecord()
    {
        newVisitRecord = new VisitRecord();
        showVisitModal = true;
    }

    private void EditVisitRecord(VisitRecord record)
    {
        newVisitRecord = new VisitRecord
        {
            Id = record.Id,
            VisitDate = record.VisitDate,
            VisitTime = record.VisitTime,
            Assignee = record.Assignee,
            VisitType = record.VisitType,
            VisitLocation = record.VisitLocation,
            VisitPurpose = record.VisitPurpose,
            CustomerMood = record.CustomerMood,
            ConversationContent = record.ConversationContent,
            CustomerConcerns = record.CustomerConcerns,
            MarketDiscussion = record.MarketDiscussion,
            InvestmentAdjustments = record.InvestmentAdjustments,
            ProductIntroduced = record.ProductIntroduced,
            CustomerFeedback = record.CustomerFeedback,
            FollowUpActions = record.FollowUpActions,
            FollowUpDate = record.FollowUpDate,
            FollowUpCompleted = record.FollowUpCompleted,
            VisitDuration = record.VisitDuration,
            VisitRating = record.VisitRating,
            NextContactSuggestion = record.NextContactSuggestion,
            IsHotLead = record.IsHotLead,
            LeadScore = record.LeadScore,
            Tags = new List<string>(record.Tags)
        };
        showVisitModal = true;
    }

    private void CloseVisitModal()
    {
        showVisitModal = false;
        newVisitRecord = new VisitRecord();
    }

    private async Task SaveVisitRecord()
    {
        if (customer != null)
        {
            customer.VisitRecords.Add(newVisitRecord);
            await CosmosDbService.UpdateCustomerAsync(customer);
            CloseVisitModal();
            await LoadCustomer();
        }
    }

    private async Task DeleteVisitRecord(string recordId)
    {
        if (customer != null && await JSRuntime.InvokeAsync<bool>("confirm", "Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÊãúË®™Ë®òÈåÑÂóéÔºü"))
        {
            customer.VisitRecords.RemoveAll(r => r.Id == recordId);
            await CosmosDbService.UpdateCustomerAsync(customer);
            await LoadCustomer();
        }
    }
}